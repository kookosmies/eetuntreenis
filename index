<!doctype html>
<html lang="fi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Eetun treeniksen varauskalenteri</title>

  <!-- FullCalendar core + interaction + dayGrid/timeGrid plugins (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />

  <style>
    /* Peruslayout */
    :root{--accent:#2b8cff;--bg:#f6f8fb;--card:#ffffff;--muted:#6b7280}
    html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial}
    body{background:linear-gradient(180deg,var(--bg),#ffffff);padding:16px;box-sizing:border-box}

    .app{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:320px 1fr;gap:16px;align-items:start}

    /* Sidebar */
    .card{background:var(--card);border-radius:12px;box-shadow:0 6px 18px rgba(30,41,59,0.06);padding:16px}
    .sidebar .brand{display:flex;gap:12px;align-items:center}
    .logo{width:48px;height:48px;background:linear-gradient(135deg,var(--accent),#6dd3ff);border-radius:10px;display:flex;align-items:center;justify-content:center;color:white;font-weight:700}
    h1{font-size:18px;margin:0}
    p.lead{color:var(--muted);margin:8px 0 16px}

    .controls{display:flex;flex-direction:column;gap:10px}
    button{background:var(--accent);color:white;border:0;padding:10px;border-radius:10px;font-weight:600;cursor:pointer}
    button.ghost{background:transparent;color:var(--accent);border:1px solid rgba(43,140,255,0.12)}
    .small{padding:8px;font-size:14px}

    .userbox{display:flex;gap:12px;align-items:center;margin-top:10px}
    .avatar{width:44px;height:44px;border-radius:999px;background:#e6eefc;display:flex;align-items:center;justify-content:center;color:var(--accent);font-weight:700}
    .userinfo{font-size:14px}
    .userinfo .email{color:var(--muted);font-size:13px}

    /* Calendar container */
    .calendar-wrap{min-height:600px}
    #calendar{background:var(--card);border-radius:12px;padding:8px}

    /* Modal (basic) */
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:none;align-items:center;justify-content:center;z-index:60}
    .modal{background:var(--card);width:min(520px,95%);border-radius:12px;padding:16px;box-shadow:0 12px 40px rgba(2,6,23,0.2)}
    .row{display:flex;gap:8px}
    input,textarea,select{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e9ee;font-size:14px}
    label{font-size:13px;color:var(--muted);margin-bottom:6px;display:block}
    .modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

    /* Responsive */
    @media (max-width:880px){
      .app{grid-template-columns:1fr;}
      .sidebar{order:2}
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="card sidebar">
      <div class="brand">
        <div class="logo">ET</div>
        <div>
          <h1>Eetun treeniksen varaukset</h1>
          <p class="lead">Katso ja tee varauksia helposti. Paina "Kirjaudu" yhdistääksesi Google-kalenteriin.</p>
        </div>
      </div>

      <div style="margin-top:12px" class="controls">
        <button id="signin-btn" class="small">Kirjaudu Googlella</button>
        <button id="signout-btn" class="small ghost" style="display:none">Kirjaudu ulos</button>

        <button id="create-btn" class="small" style="margin-top:10px;display:none">Uusi varaus</button>

        <div style="margin-top:12px">
          <strong>Kalenterinäkymä</strong>
          <div style="margin-top:8px">
            <select id="view-select">
              <option value="dayGridMonth">Kuukausi</option>
              <option value="timeGridWeek">Viikko</option>
              <option value="timeGridDay">Päivä</option>
              <option value="listWeek">Lista</option>
            </select>
          </div>
        </div>

        <div style="margin-top:12px">
          <strong>Suodatus</strong>
          <div style="margin-top:8px">
            <label><input type="checkbox" id="show-owned" checked> Näytä oman kalenterin varaukset</label>
          </div>
        </div>

        <div class="userbox" id="userbox" style="display:none">
          <div class="avatar" id="avatar">E</div>
          <div class="userinfo">
            <div id="uname">Eetu</div>
            <div class="email" id="uemail"></div>
          </div>
        </div>

      </div>
    </aside>

    <main>
      <div class="calendar-wrap card">
        <div id="calendar"></div>
      </div>
    </main>
  </div>

  <!-- Modal for creating/editing an event -->
  <div class="modal-backdrop" id="modal">
    <div class="modal" role="dialog" aria-modal="true">
      <h3 id="modal-title">Uusi varaus</h3>
      <div style="margin-top:8px">
        <label>Otsikko</label>
        <input id="ev-title" placeholder="Esim. PT-tunti" />
      </div>
      <div class="row" style="margin-top:8px">
        <div style="flex:1">
          <label>Alkaa</label>
          <input id="ev-start" type="datetime-local" />
        </div>
        <div style="flex:1">
          <label>Päättyy</label>
          <input id="ev-end" type="datetime-local" />
        </div>
      </div>
      <div style="margin-top:8px">
        <label>Viestisi / lisätiedot</label>
        <textarea id="ev-desc" rows="3" placeholder="Lisätietoja varauksesta"></textarea>
      </div>
      <div class="actions">
        <button id="cancel">Peruuta</button>
        <button id="save" style="background:var(--accent);color:white">Tallenna varaus</button>
      </div>
    </div>
  </div>

  <!-- Libraries: FullCalendar (global build) and Google API client -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <script src="https://apis.google.com/js/api.js"></script>

  <script>
    // === KONFIGUROITAVAT ARVOT ===
    // Luo Google Cloud -projekti ja ota Calendar API käyttöön.
    // Luo OAuth 2.0 Client ID (tyyppi Web) ja API key. Aseta redirect URI (esim. http://localhost:5500/ tai oman sivuston URL).
    const CLIENT_ID = '352993855802-0l6df6ovspd329etks0fmim5hr5ppat8.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyDjZ1D6BaOKeTTVRR6CV_DVs8FIUqRQrSg';
    const DISCOVERY_DOCS = ['https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest'];
    const SCOPES = 'https://www.googleapis.com/auth/calendar.events https://www.googleapis.com/auth/calendar.readonly openid email profile';
    const CALENDAR_ID = 'primary'; // tai julkinen kalenterin id jos haluat näyttää toisen

    // === ELEMENTIT ===
    const signinBtn = document.getElementById('signin-btn');
    const signoutBtn = document.getElementById('signout-btn');
    const createBtn = document.getElementById('create-btn');
    const userbox = document.getElementById('userbox');
    const uname = document.getElementById('uname');
    const uemail = document.getElementById('uemail');
    const avatar = document.getElementById('avatar');
    const modal = document.getElementById('modal');
    const saveBtn = document.getElementById('save');
    const cancelBtn = document.getElementById('cancel');

    let gcClient; // gapi client
    let calendar; // FullCalendar instance
    let currentUser = null;

    // Initialize FullCalendar
    document.addEventListener('DOMContentLoaded', function() {
      const calendarEl = document.getElementById('calendar');
      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        height: 'auto',
        selectable: true,
        selectMirror: true,
        editable: false,
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
        },
        select: function(info) {
          // avaa modal uuden varauksen luomiseen
          openModal({start: info.startStr, end: info.endStr});
        },
        eventClick: function(info) {
          // näytä tapahtuman tiedot ja mahdollisuus muokata / poistaa jos omistaja
          const ev = info.event.extendedProps.rawEvent || {}; // rawEvent tallennetaan kun haetaan
          openModal({
            id: info.event.id,
            title: info.event.title,
            start: info.event.startStr,
            end: info.event.endStr,
            description: info.event.extendedProps.description || ''
          }, true);
        },
        events: []
      });
      calendar.render();

      // view-select hook
      document.getElementById('view-select').addEventListener('change', (e)=>{
        calendar.changeView(e.target.value);
      });

      // modal handlers
      cancelBtn.addEventListener('click', closeModal);
      document.getElementById('cancel').addEventListener('click', closeModal);
      saveBtn.addEventListener('click', onSaveEvent);

      createBtn.addEventListener('click', ()=>openModal());

      // Login buttons
      signinBtn.addEventListener('click', handleAuthClick);
      signoutBtn.addEventListener('click', handleSignoutClick);

      // init gapi
      gapi.load('client:auth2', initClient);
    });

    async function initClient() {
      try {
        await gapi.client.init({apiKey: API_KEY, clientId: CLIENT_ID, discoveryDocs: DISCOVERY_DOCS, scope: SCOPES});
        gcClient = gapi.auth2.getAuthInstance();
        // listen for sign-in state changes
        gcClient.isSignedIn.listen(updateSigninStatus);
        updateSigninStatus(gcClient.isSignedIn.get());
      } catch (err) {
        console.error('gapi init error', err);
        alert('Google API -alustuksen aikana tuli virhe. Tarkista console.');
      }
    }

    function updateSigninStatus(isSignedIn) {
      if (isSignedIn) {
        const user = gcClient.currentUser.get();
        const profile = user.getBasicProfile();
        currentUser = {id: profile.getId(), name: profile.getName(), email: profile.getEmail()};
        uname.textContent = currentUser.name;
        uemail.textContent = currentUser.email;
        avatar.textContent = currentUser.name.split(' ').map(s=>s[0]).slice(0,2).join('');
        userbox.style.display = 'flex';
        signinBtn.style.display = 'none';
        signoutBtn.style.display = 'inline-block';
        createBtn.style.display = 'inline-block';
        // fetch events
        fetchAndRenderEvents();
      } else {
        currentUser = null;
        userbox.style.display = 'none';
        signinBtn.style.display = 'inline-block';
        signoutBtn.style.display = 'none';
        createBtn.style.display = 'none';
        calendar.removeAllEvents();
        // optionally load public calendar events if you have them
      }
    }

    function handleAuthClick() {
      gcClient.signIn();
    }
    function handleSignoutClick() {
      gcClient.signOut();
    }

    // Hae tapahtumat Google Calendarista ja renderöi FullCalendariin
    async function fetchAndRenderEvents() {
      try {
        // haetaan tulevat 6 kuukautta (esimerkki)
        const now = new Date();
        const timeMin = new Date(now.getFullYear(), now.getMonth()-1, 1).toISOString();
        const timeMax = new Date(now.getFullYear(), now.getMonth()+6, 1).toISOString();

        const resp = await gapi.client.calendar.events.list({calendarId: CALENDAR_ID, timeMin, timeMax, showDeleted:false, singleEvents:true, orderBy:'startTime'});
        const items = resp.result.items || [];

        // Kartoitus FullCalendar-formaattiin
        const fcEvents = items.map(ev => {
          const start = ev.start?.dateTime || ev.start?.date; // dateTime for timed events, date for all-day
          const end = ev.end?.dateTime || ev.end?.date;
          return {
            id: ev.id,
            title: ev.summary || '(Ei otsikkoa)',
            start: start,
            end: end,
            extendedProps: { rawEvent: ev, description: ev.description || '' }
          };
        });
        calendar.removeAllEvents();
        calendar.addEventSource(fcEvents);
      } catch (err) {
        console.error('fetch events error', err);
        alert('Tapahtumien hakemisessa tapahtui virhe. Tarkista konsoli.');
      }
    }

    // Modal helperit
    function openModal(data = {}, isEdit=false) {
      document.getElementById('modal-title').textContent = isEdit ? 'Muokkaa varausta' : 'Uusi varaus';
      document.getElementById('ev-title').value = data.title || '';
      document.getElementById('ev-start').value = (data.start ? toLocalDatetimeInputValue(data.start) : '');
      document.getElementById('ev-end').value = (data.end ? toLocalDatetimeInputValue(data.end) : '');
      document.getElementById('ev-desc').value = data.description || '';
      modal.style.display = 'flex';
      modal.dataset.eventId = data.id || '';
    }
    function closeModal(){ modal.style.display = 'none'; modal.dataset.eventId = ''; }

    function toLocalDatetimeInputValue(iso) {
      // iso may be date or dateTime
      const d = new Date(iso);
      // pad
      const pad = (n)=>n.toString().padStart(2,'0');
      const y = d.getFullYear();
      const m = pad(d.getMonth()+1);
      const day = pad(d.getDate());
      const hh = pad(d.getHours());
      const mm = pad(d.getMinutes());
      return `${y}-${m}-${day}T${hh}:${mm}`;
    }

    async function onSaveEvent() {
      const id = modal.dataset.eventId;
      const title = document.getElementById('ev-title').value.trim() || '(Varaus)';
      const start = document.getElementById('ev-start').value;
      const end = document.getElementById('ev-end').value;
      const desc = document.getElementById('ev-desc').value;

      if (!start || !end) { alert('Valitse aloitus- ja päättymisaika.'); return; }

      // build resource
      const resource = {
        summary: title,
        description: desc,
        start: { dateTime: new Date(start).toISOString() },
        end: { dateTime: new Date(end).toISOString() }
      };

      try {
        if (id) {
          // päivitä olemassaoleva tapahtuma
          const updated = await gapi.client.calendar.events.patch({calendarId: CALENDAR_ID, eventId: id, resource});
          console.log('updated', updated);
        } else {
          // luo uusi
          const created = await gapi.client.calendar.events.insert({calendarId: CALENDAR_ID, resource});
          console.log('created', created);
        }
        closeModal();
        fetchAndRenderEvents();
      } catch (err) {
        console.error('save event error', err);
        alert('Varausta ei voitu tallentaa. Tarkista konsoli.');
      }
    }

    // Jos haluat, voit myös lisätä tapahtuman valinnasta (esim. varauksen yhteydessä) käyttäjälle vahvistusviestin, tai lähettää webhookin backendille.

    // HUOM: tämä esimerkki käyttää ainoastaan client-side JavaScriptiä gapi:lla. 
    // - Kehitys/prod-ympäristössä on suositeltavaa tehdä tokenien hallinta ja event-insert/patch palvelinpuolelta,
    //   jotta asiakasavaimia ja refresh-token:eja ei altisteta.
    // - Muista lisätä OAuth-asiakastunnus oikeisiin redirect-URI:eihin Google Cloud Console:ssa.

  </script>
</body>
</html>
